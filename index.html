<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title></title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Gruppo&family=Kodchasan:wght@200;500&family=Montserrat&display=swap" rel="stylesheet">
</head>

<body>
  <!-- <div class="bg-image"></div> -->
  <div class="header">
    <h1>Loading...</h1>
    <div class="percent-completed-items">
      <div class="percent-completed">Loading...</div>
      <div class="percent-completed">Loading...</div>
      <div class="percent-completed">Loading...</div>
    </div>
  </div>
  <div class="modules">
    <div class="module module-habits"></div>
    <div class="module module-quota"></div>
    <div class="module module-tasks"></div>
    <div class="module module-reward"></div>
    <div class="module module-notes"></div>
  </div>
  <dialog class="new-habit-dialog">
    <form>
      <label for="habit-name">Habit Name:</label>
      <input type="text" id="habit-name" name="habit-name" placeholder="Name" required>
      <label for="start-date">Start Date:</label>
      <input type="date" id="start-date" name="start-date" required>
      <fieldset>
        <legend>Exclude Days of the Week:</legend>
        <label><input type="checkbox" name="day" value="monday"> Monday</label>
        <label><input type="checkbox" name="day" value="tuesday"> Tuesday</label>
        <label><input type="checkbox" name="day" value="wednesday"> Wednesday</label>
        <label><input type="checkbox" name="day" value="thursday"> Thursday</label>
        <label><input type="checkbox" name="day" value="friday"> Friday</label>
        <label><input type="checkbox" name="day" value="saturday"> Saturday</label>
        <label><input type="checkbox" name="day" value="sunday"> Sunday</label>
      </fieldset>
      <label for="quota-duration">Quota Duration:</label>
      <select id="quota-duration" name="quota-duration" required>
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="bi-weekly">Bi-weekly</option>
        <option value="monthly">Monthly</option>
        <option value="quarterly">Quarterly (4mo)</option>
        <option value="semi-annually">Semi-Annually (6mo)</option>
        <option value="yearly">Yearly (12mo)</option>
      </select>
      <label for="quota-amount">Quota Amount:</label>
      <input type="number" id="quota-amount" name="quota-amount" min="1" required>
      <button type="submit">Create Habit</button>
    </form>
  </dialog>
  <script>

    // let HOST = "127.0.0.1:5621"
    let HOST = "192.168.0.165:5621"

    function updateHeader() {
      let bedTime = 23; // 11pm
      let dayStart = 5; // 5am
      const elements = document.querySelectorAll(".percent-completed-items > div");
      if (elements.length >= 3) {
        let now = new Date();
        let options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        let longDate = now.toLocaleDateString('en-US', options);
        let endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, dayStart);
        let endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
        let endOfYear = new Date(now.getFullYear() + 1, 0, 1);
        let startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), dayStart);

        let totalDayMinutes = (bedTime - dayStart) * 60;
        let currentDayMinutes = (now.getHours() * 60 + now.getMinutes()) - (dayStart * 60);
        currentDayMinutes = currentDayMinutes < 0 ? 0 : currentDayMinutes; // Account for before day start
        let percentDayDone = (currentDayMinutes / totalDayMinutes) * 100;

        let daysInMonth = (endOfMonth - new Date(now.getFullYear(), now.getMonth(), 1)) / (1000 * 60 * 60 * 24);
        let percentMonthDone = ((now.getDate() - 1 + now.getHours() / 24) / daysInMonth) * 100;

        let daysInYear = (endOfYear - new Date(now.getFullYear(), 0, 1)) / (1000 * 60 * 60 * 24);
        let percentYearDone = ((now - new Date(now.getFullYear(), 0, 1)) / (daysInYear * 24 * 60 * 60 * 1000)) * 100;

        elements[0].textContent = percentDayDone.toFixed(2) + "%day done";
        elements[1].textContent = percentMonthDone.toFixed(2) + "% of month done";
        elements[2].textContent = percentYearDone.toFixed(2) + "% of year done";
        document.querySelector(".header h1").textContent = longDate;
      }
    }

    class Reward {
      constructor() {
        this.getTodaysReward().then(rewardImageUrl => {
          this.htmlContent = `
        <div class='reward-header'><p class='reward-message'>Locked</p> 
        <span class='reward-progress'>${this.getProgessBar()}</span></div>
        <img class='reward-image' src='${rewardImageUrl}?time=${new Date().getTime()}'>

      `;
          this.render();
        });
      }

      getProgessBar() {
        let totalHabits = 10;
        let totalDone = 3;
        let template = "<div class='reward-progress-{iORc}'></div>";
        let result = "";
        for (let i = 0; i < totalHabits; i++) {
          result += template.replace("{iORc}", i < totalDone ? "complete" : "incomplete");
        }
        return result;
      }

      async getTodaysReward() {
        let url = `http://${HOST}/reward`;
        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error('No image available');
          }
          return response.url;
        } catch (error) {
          console.error('Error fetching the reward image:', error);
          return 'path/to/default/image.jpg'; // Path to a default image
        }
      }

      render() {
        const moduleElement = document.querySelector('.module-reward');
        if (moduleElement) {
          moduleElement.innerHTML = this.htmlContent;
          moduleElement.className += " locked";
        }
      }
    }

    class Habit {
      constructor(name, start, history, exclusions, quota) {
        this.name = name;
        this.start = start;
        this.history = history;
        this.exclusions = exclusions;
        this.quota = quota;
      }

      // Example
      /*
        {
          "name": "Meditate",
          "start": "12/1/2023",
          "history": [
            {"date":"12/1/2023", "note":"The beginning!", "done": true},
            {"date":"12/2/2023", "note":"Tired af", "done": false}],
          "exclusions": ["sunday"],
          "quota": {"duration": "weekly", "amount": 6},
        },
      */

      metQuota() {
        let done = false;
        const today = new Date();
        const history = this.history;
        const quotaAmount = this.quota.amount;

        function isDateEqual(date1, date2) {
          return date1.getDate() === date2.getDate() &&
            date1.getMonth() === date2.getMonth() &&
            date1.getFullYear() === date2.getFullYear();
        }

        function getWeekRange(startDate) {
          let start = new Date(startDate);
          let end = new Date(start);
          end.setDate(end.getDate() + 6); // End date of the week
          return { start, end };
        }

        switch (this.quota.duration) {
          case "daily":
            done = history.some(entry => isDateEqual(new Date(entry.date), today) && entry.done);
            break;

          case "weekly":
            let startOfWeek = new Date(this.start);
            while (startOfWeek <= today) {
              const { start, end } = getWeekRange(startOfWeek);
              if (today >= start && today <= end) {
                // Count the 'done' entries within this week
                const doneCount = history.filter(entry => {
                  const entryDate = new Date(entry.date);
                  return entryDate >= start && entryDate <= end && entry.done;
                }).length;

                done = doneCount >= quotaAmount;
                break;
              }
              // Move to the next week
              startOfWeek.setDate(startOfWeek.getDate() + 7);
            }
            break;

          // Add additional cases for other durations if needed
        }

        return done;
      }

      getDone() {
        return 3;
      }

      getStreak() {
        // check if there any days missing in their entries from the day that this habit was started
      }

    }

    class Quota {
      constructor(habits) {
        let tableHtml = '<table>';
        tableHtml += '<tr><td></td></tr>';

        habits.forEach(_habit => {
          var habit = new Habit(...Object.values(_habit));
          if (habit.quota.duration == "yearly") { return; }

          let greenOrRed = habit.metQuota() ? "lightgreen" : "rgb(255, 100, 100)"
          tableHtml += `<tr title='${habit.name}' style='background: linear-gradient(to right, ${greenOrRed} 70%, transparent 70%);'>`;
          let done = habit.getDone();
          let total = habit.quota.amount
          // tableHtml += `<td>${habit.name.substr(0, 1)}</td>`;
          tableHtml += `<td>${done}/${total}</td>`;
          tableHtml += `<td>${habit.quota.duration}</td>`;
          tableHtml += '</tr>';
        })
        tableHtml += '</table>';
        self.html = tableHtml;
      }
      render() {
        const moduleHabits = document.querySelector('.module-quota');
        moduleHabits.innerHTML = self.html;
      }
    }

    function getQuotaAmount(duration) {
      const now = new Date();
      const currentYear = now.getFullYear();
      const quotaTable = {
        "daily": 1,
        "weekly": 7,
        "bi-weekly": 14,
        "monthly": new Date(currentYear, now.getMonth() + 1, 0).getDate(),
        "quarterly": (() => {
          let totalDays = 0;
          for (let i = 0; i < 4; i++) {
            totalDays += new Date(currentYear, now.getMonth() + i + 1, 0).getDate();
          }
          return totalDays;
        })(),
        "semi-annually": (() => {
          let totalDays = 0;
          for (let i = 0; i < 6; i++) {
            totalDays += new Date(currentYear, now.getMonth() + i + 1, 0).getDate();
          }
          return totalDays;
        })(),
        "yearly": (() => {
          return (new Date(currentYear, 12, 0)).getDate() - (new Date(currentYear, 0, 0)).getDate();
        })()
      };

      return quotaTable[duration];
    }

    class HabitTracker {
      constructor(habits) {
        const dayNames = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
        const currentDate = new Date();
        const currentDay = currentDate.getDay();

        // Build the table
        let tableHtml = '<table>';
        tableHtml += '<tr><th></th>';
        for (let i = 0; i < dayNames.length; i++) {
          tableHtml += `<th class="${i === currentDay ? 'current-day' : ''}">${dayNames[i]}</th>`;
        }
        tableHtml += '</tr>';

        // Loop through each habit item
        habits.forEach(habit => {

          // Will skip yearly habits and save that for another module
          if (habit.quota.duration == "yearly") { return; }

          tableHtml += `<tr>`;
          tableHtml += `<td>${habit.name}</td>`;

          // Loop through each day in the week for the habit
          for (let j = 0; j < 7; j++) {
            let className = 'habit-day';
            if (j === currentDay) { className += ' habit-day-today'; }

            // Check if the history entry exists and is valid before accessing its properties
            let historyIndex = habit.history.length - j;
            if (historyIndex >= 0 && habit.history[historyIndex] && habit.history[historyIndex].done) {
              className += ' checked';
            }

            tableHtml += `<td class="${className}" onclick="toggleCheck(this, ${j === currentDay})"></td>`;
          }

          tableHtml += '</tr>';
        });
        tableHtml += `<tr>`;
        tableHtml += `<td><a onclick="HabitTracker.openDialog()">+</a></td>`;
        tableHtml += '</tr>';


        tableHtml += '</table>';
        self.html = tableHtml;
      }

      static openDialog() {
        let dialog = document.querySelector(".new-habit-dialog");
        dialog.showModal();
      }

      render() {
        const moduleHabits = document.querySelector('.module-habits');
        moduleHabits.innerHTML = self.html;
      }
    }

    function toggleCheck(element, isToday) {
      if (isToday) {
        element.classList.toggle('checked');
      }
    }


    function getHabitHistory() {
      let habits = [
        {
          "name": "üßò‚Äç‚ôÇÔ∏èMeditate",
          "start": "12/11/2023",
          "history": [
            { "date": "12/25/2023", "note": "The beginning!", "done": true },
            { "date": "12/26/2023", "note": "Tired af", "done": true },
            { "date": "12/28/2023", "note": "Tired af", "done": true }
          ],
          "exclusions": ["sunday"],
          "quota": { "duration": "daily", "amount": 1 },
        },
        {
          "name": "Travel to a Foreign Country",
          "start": "1/1/2024",
          "history": [],
          "exclusions": [],
          "quota": { "duration": "yearly", "amount": 2 },
        },
        {
          "name": "üìñRead Book",
          "start": "1/1/2024",
          "history": [],
          "exclusions": [],
          "quota": { "duration": "monthly", "amount": 1 },
        },
        {
          "name": "üèãÔ∏èGym",
          "start": "1/1/2024",
          "history": [],
          "exclusions": [],
          "quota": { "duration": "weekly", "amount": 4 },
        },
        {
          "name": "üó£Ô∏èX Post",
          "start": "1/1/2024",
          "history": [],
          "exclusions": ["friday", "saturday", "sunday"],
          "quota": { "duration": "daily", "amount": 2 },
        },
        {
          "name": "üö´Zaza Free",
          "start": "1/1/2024",
          "history": [],
          "exclusions": [],
          "quota": { "duration": "monthly", "amount": 30 },
        },
        {
          "name": "üìàBiz Work",
          "start": "1/1/2024",
          "history": [],
          "exclusions": [],
          "quota": { "duration": "weekly", "amount": 5 },
        },
        {
          "name": "üò¥Slept 7hrs+",
          "start": "1/1/2024",
          "history": [],
          "exclusions": ["friday"],
          "quota": { "duration": "weekly", "amount": 6 },
        },
        {
          "name": "üåôLD Attempt",
          "start": "1/1/2024",
          "history": [],
          "exclusions": ["friday"],
          "quota": { "duration": "weekly", "amount": 6 },
        },
        {
          "name": "üåüLD Successüåü",
          "start": "1/1/2024",
          "history": [],
          "exclusions": [],
          "quota": { "duration": "monthly", "amount": 1 },
        }
      ];

      return habits;
    }

    let habits = getHabitHistory();
    new HabitTracker(habits).render();
    new Quota(habits).render();
    new Reward().getTodaysReward();

    updateHeader();
    setInterval(updateHeader, 10000);
  </script>
</body>

</html>